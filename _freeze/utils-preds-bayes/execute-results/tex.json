{
  "hash": "65d619e4e4b7fcf2261b194b9d5596f3",
  "result": {
    "engine": "knitr",
    "markdown": "# Utilities and predictions with Bayesian multinomial regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(brms)\nlibrary(rstan)\nlibrary(tidybayes)\nlibrary(ggdist)\nlibrary(marginaleffects)\nlibrary(parameters)\nlibrary(tinytable)\nlibrary(scales)\nlibrary(ggforce)\n\nstickers <- readRDS(\"data/processed_data/study_5_sticker.rds\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstickers_choice_alt <- stickers |>\n  mutate(choice_alt = factor(alt * choice))\n\nstickers_choice_alt |>\n  select(resp_id, question, price, packaging, flavor, choice, choice_alt)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7,080 x 7\n   resp_id question price packaging         flavor    choice choice_alt\n     <dbl>    <dbl> <fct> <fct>             <fct>      <dbl> <fct>     \n 1       4        1 $3    Plastic + sticker Chocolate      1 1         \n 2       4        1 $2    Plastic + paper   Nuts           0 0         \n 3       4        2 $3    Plastic + sticker Nuts           0 0         \n 4       4        2 $2    Plastic + paper   Chocolate      1 2         \n 5       4        3 $4    Plastic + paper   Chocolate      1 1         \n 6       4        3 $2    Plastic + sticker Chocolate      0 0         \n 7       4        4 $2    Plastic + sticker Chocolate      1 1         \n 8       4        4 $4    Plastic + paper   Nuts           0 0         \n 9       4        5 $4    Plastic + sticker Chocolate      1 1         \n10       4        5 $2    Plastic + paper   Nuts           0 0         \n# i 7,070 more rows\n```\n\n\n:::\n:::\n\n\n## Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_stickers_mega_mlm_brms <- brm(\n  bf(choice_alt ~\n    # Choice-level predictors that are nested within respondents...\n    (price + packaging + flavor) +\n    # ... with random respondent-specific slopes for the\n    # nested choice-level predictors\n    (1 + price + packaging + flavor | ID | resp_id)),\n  data = stickers_choice_alt,\n  family = categorical(refcat = \"0\"),\n  prior = c(\n    prior(normal(0, 3), class = b, dpar = mu1),\n    prior(normal(0, 3), class = b, dpar = mu2),\n    prior(exponential(1), class = sd, dpar = mu1),\n    prior(exponential(1), class = sd, dpar = mu2),\n    prior(lkj(1), class = cor)\n  ),\n  chains = 4, cores = 4, warmup = 1000, iter = 5000, seed = 1234,\n  backend = \"cmdstanr\", threads = threading(2), # refresh = 0,\n  control = list(adapt_delta = 0.9),\n  file = \"models/model_stickers_mega_mlm_brms\"\n)\n```\n:::\n\n\n\n## Part-worth utilities and ratios\n\n### Model βs\n\nThe coefficients from the model \n\n\n::: {.cell}\n\n```{.r .cell-code}\nstickers_cat_marginalized <- model_stickers_mega_mlm_brms %>% \n  gather_draws(`b_.*`, regex = TRUE) %>% \n  # Each variable name has \"mu1\", \"mu2\", etc. built in, like \"b_mu1_flavorNuts\". This\n  # splits the .variable column into two parts based on a regular expression,\n  # creating one column for the mu part (\"b_mu1_\") and one for the rest of the\n  # variable name (\"flavorNuts\")\n  separate_wider_regex(\n    .variable,\n    patterns = c(mu = \"b_mu\\\\d_\", .variable = \".*\")\n  ) %>% \n  # Find the average of the two mu estimates for each variable within each\n  # draw, or marginalize across the two options, since they're randomized\n  group_by(.variable, .draw, .chain, .iteration) %>% \n  summarize(.value = mean(.value)) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by '.variable', '.draw', '.chain'. You can\noverride using the `.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code}\nstickers_cat_marginalized |> \n  filter(.variable != \"Intercept\") |> \n  ggplot(aes(x = .value, y = .variable)) +\n  stat_halfeye() +\n  geom_vline(xintercept = 0)\n```\n\n::: {.cell-output-display}\n![](utils-preds-bayes_files/figure-pdf/unnamed-chunk-2-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstickers_cat_marginalized |> \n  group_by(.variable) |> \n  median_hdi(.value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 x 7\n  .variable                .value .lower .upper .width .point .interval\n  <chr>                     <dbl>  <dbl>  <dbl>  <dbl> <chr>  <chr>    \n1 flavorNuts               -2.56  -2.87  -2.26    0.95 median hdi      \n2 Intercept                 1.25   1.01   1.49    0.95 median hdi      \n3 packagingPlasticPsticker  0.741  0.504  0.976   0.95 median hdi      \n4 price$3                  -1.05  -1.23  -0.887   0.95 median hdi      \n5 price$4                  -2.26  -2.49  -2.03    0.95 median hdi      \n```\n\n\n:::\n:::\n\n\n### Individual part-worths\n\n\n::: {.cell}\n\n```{.r .cell-code}\npopulation_effects <- stickers_cat_marginalized |> \n  rename(value_population = .value)\n\npopulation_effects\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 80,000 x 5\n# Groups:   .variable, .draw, .chain [80,000]\n   .variable .draw .chain .iteration value_population\n   <chr>     <int>  <int>      <int>            <dbl>\n 1 Intercept     1      1          1             1.13\n 2 Intercept     2      1          2             1.47\n 3 Intercept     3      1          3             1.47\n 4 Intercept     4      1          4             1.40\n 5 Intercept     5      1          5             1.33\n 6 Intercept     6      1          6             1.35\n 7 Intercept     7      1          7             1.33\n 8 Intercept     8      1          8             1.18\n 9 Intercept     9      1          9             1.22\n10 Intercept    10      1         10             1.17\n# i 79,990 more rows\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindividual_effects <- model_stickers_mega_mlm_brms |>\n  gather_draws(`r_.*`[resp_id,term], regex = TRUE) |> \n  separate_wider_regex(\n    .variable,\n    patterns = c(mu = \"r_resp_id__mu\", .variable = \"\\\\d\")\n  ) |> \n  group_by(resp_id, term, .chain, .iteration, .draw) |> \n  summarize(.value = mean(.value)) \n```\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncombined <- individual_effects |> \n  rename(.variable = term, value_individual = .value) |> \n  left_join(population_effects, by = join_by(.variable, .chain, .iteration, .draw)) |> \n  ungroup() |> \n  filter(.variable != \"Intercept\") |> \n  mutate(utility = value_individual + value_population)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npart_worths_posterior <- combined |> \n  group_by(resp_id, .variable) |> \n  mean_hdi(utility) |> \n  select(resp_id, .variable, utility) |> \n  bind_rows(expand_grid(\n    utility = 0, \n    .variable = c(\"flavorChocolate\", \"packagingPackagingPpaper\", \"price$2\"), \n    resp_id = unique(combined$resp_id)\n  )) |> \n  mutate(feature = case_when(\n    str_starts(.variable, \"price\") ~ \"Price\",\n    str_starts(.variable, \"packaging\") ~ \"Packaging\",\n    str_starts(.variable, \"flavor\") ~ \"Flavor\"\n  )) |> \n  mutate(.variable = str_remove_all(.variable, \"^price|^packaging|^flavor\"))\n```\n:::\n\n\nIndividual utilty part-worths:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npart_worths_posterior |> \n  pivot_wider(names_from = c(feature, .variable), values_from = utility) |> \n  slice(1:5) |> \n  select(\n    ID = resp_id, `$2` = `Price_$2`, `$3` = `Price_$3`, `$4` = `Price_$4`,\n    Paper = Packaging_PackagingPpaper, Sticker = Packaging_PlasticPsticker,\n    Chocolate = Flavor_Chocolate, Nuts = Flavor_Nuts\n  ) |> \n  tt() |> \n  format_tt(j = 2:8, digits = 2, num_zero = TRUE, num_fmt = \"significant\") |> \n  group_tt(\n    j = list(\n      \"Price\" = 2:4,\n      \"Packaging\" = 5:6,\n      \"Flavor\" = 7:8\n    )\n  ) |> \n  style_tt(\n    i = 1:5,\n    j = c(2, 5, 7), line = \"l\"\n  ) |> \n  style_tt(\n    i = 1, background = \"yellow\"\n  )\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{tblr}[         %% tabularray outer open\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]Q[]Q[]Q[]Q[]},\nrow{3}={}{bg=cFFFF00,},\ncell{1}{2}={c=3,}{halign=c,},\ncell{1}{5}={c=2,}{halign=c,},\ncell{1}{7}={c=2,}{halign=c,},\nvline{2,5,7}={3-7}{solid, black, 0.1em},\n}                     %% tabularray inner close\n\\tinytableDefineColor{cFFFF00}{HTML}{FFFF00}\n\\toprule\n& Price &  &  & Packaging &  & Flavor &  \\\\ \\cmidrule[lr]{2-4}\\cmidrule[lr]{5-6}\\cmidrule[lr]{7-8}\nID & $2 & $3 & $4 & Paper & Sticker & Chocolate & Nuts \\\\ \\midrule %% TinyTableHeader\n4 & 0 & -0.82 & -1.6 & 0 & -1.66 & 0 & -4.109 \\\\\n5 & 0 & -1.42 & -3.3 & 0 & 0.27 & 0 & -0.074 \\\\\n6 & 0 & -0.90 & -1.9 & 0 & 1.18 & 0 & -3.275 \\\\\n7 & 0 & -1.00 & -1.6 & 0 & 1.20 & 0 & -3.641 \\\\\n8 & 0 & -0.84 & -1.6 & 0 & 2.36 & 0 & -3.557 \\\\\n\\bottomrule\n\\end{tblr}\n\\end{table}\n:::\n:::\n\n\nFor respondent 4, the difference in preference when moving from \\$2 to \\$4 is roughly the same as the preference for a sticker\n\nWe can also calculate the relative importance of each attribute for each individual by determining how much each attribute contributes to the overall utility of the choice. We first calculate the range of each \n\n\n::: {.cell}\n\n```{.r .cell-code}\npart_worths_posterior |> \n  filter(resp_id == 4) |> \n  arrange(.variable) |> \n  group_by(resp_id, feature) |> \n  summarize(\n    range_text = glue::glue(\"{round(max(utility), 2)} − {round(min(utility), 2)}\"),\n    range = diff(range(utility))) |> \n  mutate(pct_importance = range / sum(range)) |> \n  ungroup() |> \n  arrange(desc(feature)) |> \n  janitor::adorn_totals() |> \n  tt() |> \n  format_tt(digits = 3, num_zero = TRUE, num_fmt = \"significant\") |> \n  format_tt(j = 5, fn = scales::label_percent(accuracy = 0.1))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'resp_id'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{tblr}[         %% tabularray outer open\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]Q[]},\n}                     %% tabularray inner close\n\\toprule\nresp_id & feature & range_text & range & pct_importance \\\\ \\midrule %% TinyTableHeader\n4 & Price & 0 − -1.61 & 1.61 & 21.8% \\\\\n4 & Packaging & 0 − -1.66 & 1.66 & 22.5% \\\\\n4 & Flavor & 0 − -4.11 & 4.11 & 55.7% \\\\\nTotal & - & - & 7.37 & 100.0% \\\\\n\\bottomrule\n\\end{tblr}\n\\end{table}\n:::\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npref_ranges_posterior <- combined |> \n  mutate(feature = case_when(\n    str_starts(.variable, \"price\") ~ \"Price\",\n    str_starts(.variable, \"packaging\") ~ \"Packaging\",\n    str_starts(.variable, \"flavor\") ~ \"Flavor\"\n  )) |> \n  mutate(.variable = str_remove_all(.variable, \"^price|^packaging|^flavor\")) |> \n  group_by(resp_id, feature, .draw) |> \n  summarize(range = diff(range(c(0, utility)))) |> \n  group_by(resp_id, .draw) |> \n  mutate(pct_importance = range / sum(range))\n```\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nasdf <- pref_ranges_posterior |> \n  group_by(resp_id, feature) |> \n  summarize(\n    range = mean(range),\n    relative_importance = mean(pct_importance)\n  ) |> \n  filter(resp_id %in% 4:8) |> \n  pivot_wider(names_from = feature, values_from = c(range, relative_importance))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'resp_id'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code}\nasdf |> \n  setNames(c(\"ID\", \"Flavor\", \"Packaging\", \"Price\", \"Flavor\", \"Packaging\", \"Price\")) |> \n  tt() |> \n  format_tt(j = 2:4, digits = 2, num_zero = TRUE, num_fmt = \"significant\") |> \n  group_tt(\n    j = list(\n      \"Range\" = 2:4,\n      \"Importance\" = 5:7\n    )\n  ) |> \n  style_tt(\n    i = 1:5,\n    j = c(2, 5), line = \"l\"\n  ) |> \n  format_tt(j = 5:7, fn = scales::label_percent(accuracy = 0.1))\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{tblr}[         %% tabularray outer open\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]Q[]Q[]Q[]},\ncell{1}{2}={c=3,}{halign=c,},\ncell{1}{5}={c=3,}{halign=c,},\nvline{2,5}={3-7}{solid, black, 0.1em},\n}                     %% tabularray inner close\n\\toprule\n& Range &  &  & Importance &  &  \\\\ \\cmidrule[lr]{2-4}\\cmidrule[lr]{5-7}\nID & Flavor & Packaging & Price & Flavor & Packaging & Price \\\\ \\midrule %% TinyTableHeader\n4 & 4.11 & 1.70 & 1.7 & 55.7% & 21.6% & 22.7% \\\\\n5 & 0.74 & 0.71 & 3.3 & 15.0% & 14.4% & 70.6% \\\\\n6 & 3.28 & 1.28 & 2.0 & 50.4% & 18.9% & 30.7% \\\\\n7 & 3.64 & 1.28 & 1.7 & 55.3% & 18.8% & 26.0% \\\\\n8 & 3.56 & 2.36 & 1.6 & 47.0% & 30.7% & 22.3% \\\\\n\\bottomrule\n\\end{tblr}\n\\end{table}\n:::\n:::\n\n\nFinally, we can aggregate these individual importance ratios into overall averages:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npref_ranges_posterior |> \n  group_by(feature, .draw) |> \n  summarize(relative_importance = mean(pct_importance)) |> \n  median_hdi(relative_importance)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'feature'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 x 7\n  feature   relative_importance .lower .upper .width .point .interval\n  <chr>                   <dbl>  <dbl>  <dbl>  <dbl> <chr>  <chr>    \n1 Flavor                  0.421  0.406  0.436   0.95 median hdi      \n2 Packaging               0.211  0.197  0.226   0.95 median hdi      \n3 Price                   0.367  0.350  0.385   0.95 median hdi      \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npref_ranges_posterior |> \n  group_by(feature, .draw) |> \n  summarize(relative_importance = mean(pct_importance)) |> \n  ungroup() |> \n  mutate(feature = fct_reorder(feature, relative_importance)) |> \n  ggplot(aes(x = relative_importance, y = feature)) +\n  stat_ccdfinterval(aes(fill = feature)) +\n  # stat_ccdfinterval(aes(fill = feature, slab_alpha = after_stat(f)),\n  #   thickness = 1, fill_type = \"gradient\"\n  # ) +\n  expand_limits(x = 0) +\n  scale_x_continuous(labels = scales::label_percent()) +\n  guides(fill = \"none\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'feature'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](utils-preds-bayes_files/figure-pdf/unnamed-chunk-15-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n## Predictions and transformations\n\n### Willingness-to-pay\n\n### Simulated choice shares\n\n\n## Market simulations?\n",
    "supporting": [
      "utils-preds-bayes_files/figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{\"knit_meta_id\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"\",\"\",\"\",\"\",\"\",\"\"]}},\"value\":[{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabularray\"]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"\\\\usepackage[normalem]{ulem}\",\"\\\\usepackage{graphicx}\",\"\\\\usepackage{rotating}\",\"\\\\UseTblrLibrary{booktabs}\",\"\\\\UseTblrLibrary{siunitx}\",\"\\\\NewTableCommand{\\\\tinytableDefineColor}[3]{\\\\definecolor{#1}{#2}{#3}}\",\"\\\\newcommand{\\\\tinytableTabularrayUnderline}[1]{\\\\underline{#1}}\",\"\\\\newcommand{\\\\tinytableTabularrayStrikeout}[1]{\\\\sout{#1}}\"]}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabularray\"]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"\\\\usepackage[normalem]{ulem}\",\"\\\\usepackage{graphicx}\",\"\\\\usepackage{rotating}\",\"\\\\UseTblrLibrary{booktabs}\",\"\\\\UseTblrLibrary{siunitx}\",\"\\\\NewTableCommand{\\\\tinytableDefineColor}[3]{\\\\definecolor{#1}{#2}{#3}}\",\"\\\\newcommand{\\\\tinytableTabularrayUnderline}[1]{\\\\underline{#1}}\",\"\\\\newcommand{\\\\tinytableTabularrayStrikeout}[1]{\\\\sout{#1}}\"]}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabularray\"]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"\\\\usepackage[normalem]{ulem}\",\"\\\\usepackage{graphicx}\",\"\\\\usepackage{rotating}\",\"\\\\UseTblrLibrary{booktabs}\",\"\\\\UseTblrLibrary{siunitx}\",\"\\\\NewTableCommand{\\\\tinytableDefineColor}[3]{\\\\definecolor{#1}{#2}{#3}}\",\"\\\\newcommand{\\\\tinytableTabularrayUnderline}[1]{\\\\underline{#1}}\",\"\\\\newcommand{\\\\tinytableTabularrayStrikeout}[1]{\\\\sout{#1}}\"]}]}]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}