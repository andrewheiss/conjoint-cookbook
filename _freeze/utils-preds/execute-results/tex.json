{
  "hash": "21f40ed018567c1429cfd6a35545b1c6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Descriptive estimands\"\nsubtitle: \"Utilities, predictions, and simulations\"\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(mlogit)\nlibrary(marginaleffects)\nlibrary(parameters)\nlibrary(tinytable)\nlibrary(scales)\nlibrary(ggforce)\n\nstickers <- readRDS(\"data/processed_data/study_5_sticker.rds\")\n\nstickers_indexed <- stickers |> \n  group_by(resp_id, question) |> \n  mutate(choice_id = cur_group_id()) |> \n  ungroup() |> \n  as.data.frame() |>  # mlogit() complains and breaks when working with tibbles :(\n  dfidx(\n    idx = list(c(\"choice_id\", \"resp_id\"), \"alt\"),\n    choice = \"choice\",\n    shape = \"long\"\n  )\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_mlogit <- mlogit(\n  choice ~ 0 + price + packaging + flavor,\n  data = stickers_indexed\n)\n\npars_random <- rep(\"n\", length(model_mlogit$coefficients)) |> \n  setNames(names(model_mlogit$coef))\n\nmodel_mlogit_hierarchical <- mlogit(\n  choice ~ 0 + price + packaging + flavor,\n  rpar = pars_random, panel = TRUE, correlation = TRUE,\n  data = stickers_indexed\n)\n```\n:::\n\n\n\n## Population-level stuff\n\n### Model βs\n\n\n::: {.cell}\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{tblr}[         %% tabularray outer open\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]Q[]Q[]Q[]},\n}                     %% tabularray inner close\n\\toprule\nParameter & Coefficient & SE & CI_low & CI_high & z & p \\\\ \\midrule %% TinyTableHeader\nprice$3 & -1.82 & 0.15 & -2.11 & -1.53 & -12.33 & <0.001 \\\\\nprice$4 & -3.98 & 0.22 & -4.42 & -3.54 & -17.79 & <0.001 \\\\\npackagingPlastic + sticker & 1.23 & 0.12 & 0.99 & 1.47 & 10.00 & <0.001 \\\\\nflavorNuts & -3.93 & 0.23 & -4.38 & -3.48 & -17.06 & <0.001 \\\\\n\\bottomrule\n\\end{tblr}\n\\end{table}\n:::\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](utils-preds_files/figure-pdf/unnamed-chunk-3-1.pdf)\n:::\n:::\n\n\n## Individual-level stuff: Part-worth utilities and ratios\n\n\n::: {.cell}\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{tblr}[         %% tabularray outer open\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]Q[]Q[]Q[]Q[]},\ncell{1}{2}={c=3,}{halign=c,},\ncell{1}{5}={c=2,}{halign=c,},\ncell{1}{7}={c=2,}{halign=c,},\ncell{3}{2}={}{bg=cFFFF00,},\ncell{3}{3}={}{bg=cFFFF00,},\ncell{3}{4}={}{bg=cFFFF00,},\ncell{3}{5}={}{bg=cADD8E6,},\ncell{3}{6}={}{bg=cADD8E6,},\ncell{3}{7}={}{bg=c90EE90,},\ncell{3}{8}={}{bg=c90EE90,},\nvline{2,5,7}={3-7}{solid, black, 0.1em},\n}                     %% tabularray inner close\n\\tinytableDefineColor{c90EE90}{HTML}{90EE90}\n\\tinytableDefineColor{cADD8E6}{HTML}{ADD8E6}\n\\tinytableDefineColor{cFFFF00}{HTML}{FFFF00}\n\\toprule\n& Price &  &  & Packaging &  & Flavor &  \\\\ \\cmidrule[lr]{2-4}\\cmidrule[lr]{5-6}\\cmidrule[lr]{7-8}\nID & $2 & $3 & $4 & Paper & Sticker & Chocolate & Nuts \\\\ \\midrule %% TinyTableHeader\n4 & 0 & -2.22 & -3.98 & 0 & -4.24 & 0 & -9.76 \\\\\n5 & 0 & -2.55 & -5.99 & 0 & -0.19 & 0 & -0.14 \\\\\n6 & 0 & -1.31 & -2.87 & 0 & 2.67 & 0 & -8.60 \\\\\n7 & 0 & -1.61 & -3.34 & 0 & 2.63 & 0 & -6.78 \\\\\n8 & 0 & -1.57 & -3.71 & 0 & 3.49 & 0 & -4.41 \\\\\n\\bottomrule\n\\end{tblr}\n\\end{table}\n:::\n:::\n\n\nFor respondent 4, the difference in preference when moving from \\$2 to \\$4 is roughly the same as the preference for a sticker\n\nWe can also calculate the relative importance of each attribute for each individual by determining how much each attribute contributes to the overall utility of the choice. We first calculate the range of each\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'id'. You can override using the `.groups`\nargument.\n```\n\n\n:::\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{tblr}[         %% tabularray outer open\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]},\ncell{2}{2}={}{bg=cFFFF00,},\ncell{3}{2}={}{bg=cADD8E6,},\ncell{4}{2}={}{bg=c90EE90,},\nhline{5}={1-4}{solid, black, 0.1em},\n}                     %% tabularray inner close\n\\tinytableDefineColor{c90EE90}{HTML}{90EE90}\n\\tinytableDefineColor{cADD8E6}{HTML}{ADD8E6}\n\\tinytableDefineColor{cFFFF00}{HTML}{FFFF00}\n\\toprule\nFeature & max(β<sub>i</sub>) − min(β<sub>i</sub>) & Range & Importance \\\\ \\midrule %% TinyTableHeader\nPrice & 0 − -3.98 & 3.98 & 22.1% \\\\\nPackaging & 0 − -4.24 & 4.24 & 23.6% \\\\\nFlavor & 0 − -9.76 & 9.76 & 54.3% \\\\\nTotal &  & 17.99 & 100.0% \\\\\n\\bottomrule\n\\end{tblr}\n\\end{table}\n:::\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{tblr}[         %% tabularray outer open\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]Q[]Q[]Q[]},\ncell{1}{2}={c=3,}{halign=c,},\ncell{1}{5}={c=3,}{halign=c,},\nvline{2,5}={3-7}{solid, black, 0.1em},\n}                     %% tabularray inner close\n\\toprule\n& Range &  &  & Importance &  &  \\\\ \\cmidrule[lr]{2-4}\\cmidrule[lr]{5-7}\nID & Price & Packaging & Flavor & Price  & Packaging  & Flavor  \\\\ \\midrule %% TinyTableHeader\n4 & 3.98 & 4.24 & 9.76 & 22.1% & 23.6% & 54.3% \\\\\n5 & 5.99 & 0.19 & 0.14 & 94.7% & 3.1% & 2.2% \\\\\n6 & 2.87 & 2.67 & 8.60 & 20.3% & 18.9% & 60.8% \\\\\n7 & 3.34 & 2.63 & 6.78 & 26.2% & 20.6% & 53.2% \\\\\n8 & 3.71 & 3.49 & 4.41 & 32.0% & 30.0% & 38.0% \\\\\n\\bottomrule\n\\end{tblr}\n\\end{table}\n:::\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](utils-preds_files/figure-pdf/unnamed-chunk-7-1.pdf)\n:::\n:::\n\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'feature'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](utils-preds_files/figure-pdf/unnamed-chunk-8-1.pdf)\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor.mlogit(model_mlogit_hierarchical) |> \n  as_tibble(rownames = \"coefficient\") |> \n  tt() |> \n  format_tt(j = 2:5, fn = scales::label_number(accuracy = 0.001))\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{tblr}[         %% tabularray outer open\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]Q[]},\n}                     %% tabularray inner close\n\\toprule\ncoefficient & price$3 & price$4 & packagingPlastic + sticker & flavorNuts \\\\ \\midrule %% TinyTableHeader\nprice$3 & 1.000 & 0.899 & 0.727 & 0.069 \\\\\nprice$4 & 0.899 & 1.000 & 0.529 & 0.132 \\\\\npackagingPlastic + sticker & 0.727 & 0.529 & 1.000 & 0.240 \\\\\nflavorNuts & 0.069 & 0.132 & 0.240 & 1.000 \\\\\n\\bottomrule\n\\end{tblr}\n\\end{table}\n:::\n:::\n\n\n## Predictions and transformations\n\n### Willingness-to-pay?\n\n### Simulated choice shares\n\nFunctions from @Feit:2019\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredict_mnl <- function(model, data) {\n  # Function for predicting shares from a multinomial logit model \n  # model: mlogit object returned by mlogit()\n  # data: a data frame containing the set of designs for which you want to \n  #       predict shares. Same format at the data used to estimate model. \n  data.model <- model.matrix(update(model$formula, 0 ~ .), data = data)[ , -1]\n  utility <- data.model %*% model$coef\n  share <- exp(utility) / sum(exp(utility))\n  cbind(share, data)\n}\n\npredict_hier_mnl <- function(model, data, nresp =1000) { \n  # Function to predict shares of a hierarchical multinomial logit model\n  # model: mlogit object returned by mlogit()\n  # data: a data frame containing the set of designs for which you want to\n  # predict shares. Same format at the data used to estimate model.\n  # Note that this code assumes all model parameters are random\n  data.model <- model.matrix(update(model$formula , 0 ~ .), data = data)[ , -1]\n  coef.Sigma <- cov.mlogit(model)\n  coef.mu <- model$coef[1:dim(coef.Sigma)[1]]\n  draws <- MASS::mvrnorm(n = nresp, coef.mu, coef.Sigma)\n  shares <- matrix(NA, nrow = nresp, ncol = nrow(data))\n\n  for (i in 1:nresp) {\n    utility <- data.model%*%draws[i,]\n    share <- exp(utility)/sum(exp(utility))\n    shares[i,] <- share \n  }\n\n  cbind(colMeans(shares), data)\n}\n\nexample_product_mix <- tribble(\n  ~price, ~packaging, ~flavor,\n  \"$2\", \"Plastic + sticker\", \"Chocolate\",\n  \"$3\", \"Plastic + sticker\", \"Chocolate\",\n  \"$4\", \"Plastic + sticker\", \"Chocolate\",\n  \"$2\", \"Plastic + paper\", \"Nuts\",\n  \"$3\", \"Plastic + paper\", \"Nuts\",\n  \"$4\", \"Plastic + paper\", \"Nuts\"\n) |> \n  mutate(across(everything(), factor))\n\npredict_hier_mnl(model_mlogit_hierarchical, example_product_mix)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  colMeans(shares) price         packaging    flavor\n1       0.65224125    $2 Plastic + sticker Chocolate\n2       0.12375704    $3 Plastic + sticker Chocolate\n3       0.04413602    $4 Plastic + sticker Chocolate\n4       0.15247751    $2   Plastic + paper      Nuts\n5       0.02051277    $3   Plastic + paper      Nuts\n6       0.00687542    $4   Plastic + paper      Nuts\n```\n\n\n:::\n:::\n\n\n## Market simulations?\n",
    "supporting": [
      "utils-preds_files/figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{\"knit_meta_id\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"]}},\"value\":[{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabularray\"]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"\\\\usepackage[normalem]{ulem}\",\"\\\\usepackage{graphicx}\",\"\\\\usepackage{rotating}\",\"\\\\UseTblrLibrary{booktabs}\",\"\\\\UseTblrLibrary{siunitx}\",\"\\\\NewTableCommand{\\\\tinytableDefineColor}[3]{\\\\definecolor{#1}{#2}{#3}}\",\"\\\\newcommand{\\\\tinytableTabularrayUnderline}[1]{\\\\underline{#1}}\",\"\\\\newcommand{\\\\tinytableTabularrayStrikeout}[1]{\\\\sout{#1}}\"]}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabularray\"]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"\\\\usepackage[normalem]{ulem}\",\"\\\\usepackage{graphicx}\",\"\\\\usepackage{rotating}\",\"\\\\UseTblrLibrary{booktabs}\",\"\\\\UseTblrLibrary{siunitx}\",\"\\\\NewTableCommand{\\\\tinytableDefineColor}[3]{\\\\definecolor{#1}{#2}{#3}}\",\"\\\\newcommand{\\\\tinytableTabularrayUnderline}[1]{\\\\underline{#1}}\",\"\\\\newcommand{\\\\tinytableTabularrayStrikeout}[1]{\\\\sout{#1}}\"]}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabularray\"]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"\\\\usepackage[normalem]{ulem}\",\"\\\\usepackage{graphicx}\",\"\\\\usepackage{rotating}\",\"\\\\UseTblrLibrary{booktabs}\",\"\\\\UseTblrLibrary{siunitx}\",\"\\\\NewTableCommand{\\\\tinytableDefineColor}[3]{\\\\definecolor{#1}{#2}{#3}}\",\"\\\\newcommand{\\\\tinytableTabularrayUnderline}[1]{\\\\underline{#1}}\",\"\\\\newcommand{\\\\tinytableTabularrayStrikeout}[1]{\\\\sout{#1}}\"]}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabularray\"]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"\\\\usepackage[normalem]{ulem}\",\"\\\\usepackage{graphicx}\",\"\\\\usepackage{rotating}\",\"\\\\UseTblrLibrary{booktabs}\",\"\\\\UseTblrLibrary{siunitx}\",\"\\\\NewTableCommand{\\\\tinytableDefineColor}[3]{\\\\definecolor{#1}{#2}{#3}}\",\"\\\\newcommand{\\\\tinytableTabularrayUnderline}[1]{\\\\underline{#1}}\",\"\\\\newcommand{\\\\tinytableTabularrayStrikeout}[1]{\\\\sout{#1}}\"]}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabularray\"]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"\\\\usepackage[normalem]{ulem}\",\"\\\\usepackage{graphicx}\",\"\\\\usepackage{rotating}\",\"\\\\UseTblrLibrary{booktabs}\",\"\\\\UseTblrLibrary{siunitx}\",\"\\\\NewTableCommand{\\\\tinytableDefineColor}[3]{\\\\definecolor{#1}{#2}{#3}}\",\"\\\\newcommand{\\\\tinytableTabularrayUnderline}[1]{\\\\underline{#1}}\",\"\\\\newcommand{\\\\tinytableTabularrayStrikeout}[1]{\\\\sout{#1}}\"]}]}]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}